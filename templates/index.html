<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>📡 6사보도망 서비스 내역</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "",
      authDomain: "sabodo-82fa8.firebaseapp.com",
      projectId: "sabodo-82fa8",
      storageBucket: "sabodo-82fa8.firebasestorage.app",
      messagingSenderId: "411843694800",
      appId: "1:411843694800:web:94e40d6ec9f05cdd60ced5",
      measurementId: "G-CKBERJMFMG"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const tableRef = db.collection("logTable");
    const alarmRef = db.collection("system").doc("alarmStatus"); // Firestore에서 알람 상태를 관리

    // 로그인 상태 확인 함수
    function checkLogin() {
      const currentUser = localStorage.getItem("username");
      if (currentUser) {
        document.getElementById("login-container").style.display = "none";
        document.getElementById("service-container").style.display = "block";
        document.getElementById("currentUser").innerText = `${currentUser} 님, 환영합니다!`;  // 로그인한 계정 표시
        loadTable();
        listenToAlarmStatus(); // 알람 상태 리스너 시작
      } else {
        document.getElementById("login-container").style.display = "block";
        document.getElementById("service-container").style.display = "none";
      }
    }

    // 로그인 함수
    function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const validUsers = {
        "itc": "itc",
        "kbs": "kbs",
        "mbc": "mbc",
        "sbs": "sbs",
        "ytn": "ytn",
        "mbn": "mbn",
        "obs": "obs"
      };

      if (validUsers[username] && validUsers[username] === password) {
        localStorage.setItem("username", username);
        checkLogin();
      } else {
        document.getElementById("error-message").innerText = "아이디나 비밀번호가 틀렸습니다.";
      }
    }


    // 로그아웃 함수
    function logout() {
      localStorage.removeItem("username");
      checkLogin();
    }

    /**
 * 내용 셀 수정 후 호출됩니다.
 * @param {string} id    - Firestore 문서 ID
 * @param {string} text  - 입력된 내용
 */
function onContentChange(id, text) {
  // 내용이 비어있으면 아무 것도 안 함
  if (!text.trim()) return;

  const now = new Date();
  // YYYY-MM-DD 포맷
  const date = [
    now.getFullYear(),
    String(now.getMonth() + 1).padStart(2, '0'),
    String(now.getDate()).padStart(2, '0')
  ].join('-');
  // HH:MM:SS 포맷
  const time = [
    String(now.getHours()).padStart(2, '0'),
    String(now.getMinutes()).padStart(2, '0'),
    String(now.getSeconds()).padStart(2, '0')
  ].join(':');

  // Firestore에 한꺼번에 업데이트
  tableRef.doc(id).update({
    content: text,
    date: date,
    time: time
  }).then(() => {
    loadTable();  // UI 새로고침
  });
}


    /**
 * 모든 문서의 history 서브콜렉션을 타임스탬프 내림차순으로 조회하여
 * alert 등으로 출력
 */
function showAllHistory() {
  // collectionGroup 으로 모든 'history' 서브콜렉션을 한 번에 가져온다
  db.collectionGroup('history')
    .orderBy('timestamp', 'desc')
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        alert('전체 변경 이력이 없습니다.');
        return;
      }
      // 출력 메시지 누적
      let msg = '';
      snapshot.forEach(doc => {
        const d = doc.data();
        const time = d.timestamp?.toDate().toLocaleString() || '';
        msg += `[${time}] ${d.user || '-'}님이 ${d.field}을 ` +
               `"${d.oldValue}" → "${d.newValue}" 으로 변경\n`;
      });
      // 길면 console.log로 내려받기
      if (msg.length > 1000) {
        console.log(msg);
        alert('전체 이력이 너무 깁니다. 개발자 콘솔을 확인하세요.');
      } else {
        alert(msg);
      }
    })
    .catch(err => {
      console.error(err);
      alert('이력을 불러오는 중 오류가 발생했습니다.');
    });
}


    
    // 알람 상태 리스너
    function listenToAlarmStatus() {
      alarmRef.onSnapshot(doc => {
        const alarmStatus = doc.data();
        if (alarmStatus && alarmStatus.isAlarmActive) {
          document.getElementById("alarmSound").play(); // 알람 울리기
        } else {
          document.getElementById("alarmSound").pause(); // 알람 정지
          document.getElementById("alarmSound").currentTime = 0;
        }
      });
    }

    // 알람 시작 함수
    function sendAlarm() {
      alarmRef.set({isAlarmActive: true}).then(() => {
        console.log("알람이 울렸습니다.");
      });
    }

    // 알람 정지 함수
    function stopAlarm() {
      alarmRef.set({isAlarmActive: false}).then(() => {
        console.log("알람이 정지되었습니다.");
      });
    }

    // 데이터 로드 함수
    function loadTable() {
      const currentUser = localStorage.getItem("username"); // 로그인된 사용자
      const receivers = ["KBS", "MBC", "SBS", "MBN", "YTN", "OBS"];

      tableRef.get().then(snapshot => {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = ""; // 테이블 초기화

        snapshot.forEach(doc => {
          const data = doc.data();
          const rowId = doc.id;  // 행 ID

          const tr = document.createElement("tr");
          tr.setAttribute("data-row-id", rowId);  // 행 ID를 data-row-id로 설정

          // 수신사별로 제외 상태를 체크하여, 해당 수신사에서 제외된 행만 숨김
          let shouldDisplayRow = true;

          receivers.forEach((name, idx) => {
            // 로그인된 계정이 해당 수신사일 경우, 대소문자 구분 없이 비교
            if (currentUser.toUpperCase() === name.toUpperCase() && data[name] && data[name].exclude === "제외!") {
              shouldDisplayRow = false;  // 해당 수신사에서 제외된 경우 해당 행을 숨기도록 설정
            }
          });

          // 행을 숨기지 않도록 설정
          if (!shouldDisplayRow) {
            tr.style.display = "none";  // 해당 수신사에서 제외된 경우 해당 행을 숨김
          }

          tr.innerHTML = `
            <td><input type="checkbox" /></td>
            <td contenteditable="true" onblur="updateCell('${doc.id}', 'date', this.innerText)">${data.date || ''}</td>
            <td contenteditable="true" onblur="updateCell('${doc.id}', 'time', this.innerText)">${data.time || ''}</td>
            <td contenteditable="true" onblur="onContentChange('${doc.id}', this.innerText)">${data.content || ''}</td>
            <td contenteditable="true" onblur="updateCell('${doc.id}', 'sender', this.innerText)">${data.sender || ''}</td>
            ${receivers.map(rcv => `
              <td>
                <button onclick="toggleAck('${doc.id}', '${rcv}')">${(data[rcv] && data[rcv].ack) || '확인!'}</button>
                <button onclick="toggleExclude(this, '${doc.id}', '${rcv}')" class="${(data[rcv] && data[rcv].exclude === '제외!') ? 'exclude-btn active' : 'exclude-btn'}">${(data[rcv] && data[rcv].exclude) || '포함'}</button>
              </td>
            `).join('')}
          `;
          tbody.appendChild(tr);
          // ⭐ 날짜별 건수 세기
          if (data.date) {
            if (dateCounts[data.date]) {
              dateCounts[data.date]++;
            } else {
              dateCounts[data.date] = 1;
            }
          }

        
        });
      });
    }

    // 셀 업데이트 함수
    function updateCell(id, field, value) {
      tableRef.doc(id).update({[field]: value}).then(() => loadTable());
    }

    // 확인 상태 토글
    function toggleAck(id, rcv) {
      const cellRef = tableRef.doc(id);
      cellRef.get().then(doc => {
        const data = doc.data();
        const current = (data[rcv] && data[rcv].ack) || '확인!';
        const updated = current === '확인!' ? '✅ 확인됨' : '확인!';
        cellRef.update({[`${rcv}.ack`]: updated}).then(() => {
          loadTable();
        });
      });
    }

    // 제외 상태 토글 (해당 계정에만 적용)
    function toggleExclude(btn, id, rcv) {
      const currentUser = localStorage.getItem("username");
      const cellRef = tableRef.doc(id);

      // Firestore에서 해당 행의 데이터를 가져옴
      cellRef.get().then(doc => {
        const data = doc.data();

        // 현재 상태 가져오기
        const current = (data[rcv] && data[rcv].exclude) || '제외';

        // 새로운 제외 상태
        const updated = current === '제외' ? '제외!' : '제외';

        // 제외 상태를 Firestore에 업데이트 (현재 계정에 대해서만)
        cellRef.update({
          [`${rcv}.exclude`]: updated,
          [`${rcv}.ack`]: '확인!'  // 확인 상태 초기화
        }).then(() => {
          // 즉시 반영
          loadTable();

          // 버튼 색 변경: 빨간색으로 표시
          btn.classList.toggle('active');
        });
      });
    }

    // 행 추가 함수
    function addRow() {
      const rowData = {
        date: '', time: '', content: '', sender: ''
      };
      const receivers = ["KBS", "MBC", "SBS", "MBN", "YTN", "OBS"];
      receivers.forEach(rcv => {
        rowData[rcv] = {ack: '확인!', exclude: '포함'};
      });
      tableRef.add(rowData).then(() => {
        loadTable();
      });
    }

    function saveData() {
      alert("저장되었습니다!");
    }


    // 행 삭제 함수
    function deleteRow() {
      tableRef.get().then(snapshot => {
        const rows = document.querySelectorAll("#logTable tbody tr");
        snapshot.docs.forEach((doc, index) => {
          if (rows[index].querySelector("input").checked) {
            doc.ref.delete().then(() => {
              loadTable();
            });
          }
        });
      });
    }

    // 페이지 로딩 시 로그인 상태 확인
    document.addEventListener("DOMContentLoaded", checkLogin);

    // 새로고침 버튼 클릭 시 페이지 리프레시
    document.addEventListener("DOMContentLoaded", function () {
      const refreshButton = document.getElementById("refreshButton");
      if (refreshButton) {
        refreshButton.addEventListener("click", function () {
          window.location.reload(); // 페이지 리프레시
        });
      }
    });

    // 1분마다 자동으로 페이지 리프레시
    setInterval(function () {
      window.location.reload(); // 페이지 리프레시
    }, 60000); // 60000ms = 1분
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      position: relative;
      background-color: #f4f4f4;
    }

    h1 {
      text-align: center;
    }

    .button-container {
      text-align: center;
      margin-bottom: 20px;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .send,
    .stop,
    .add,
    .delete,
    .save,
    .refresh,
    .logout {
      background-color: #2196F3;
      color: white;
    }

    .send {
      background-color: #FF9800;
    }

    .stop {
      background-color: #f44336;
    }

    .add,
    .delete,
    .save {
      background-color: #4CAF50;
    }

    .exclude-btn.active {
      background-color: #f44336;
      color: white;
    }

    .exclude-btn {
      background-color: #2196F3;
      color: white;
    }

    .logout {
      background-color: #9C27B0;
    }

    .login-container {
      max-width: 400px;
      margin: 0 auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .login-container input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .login-container button {
      width: 100%;
      padding: 12px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .login-container button:hover {
      background-color: #1976D2;
    }

    .error-message {
      color: red;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
    }

    thead th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    td[contenteditable] {
      background-color: #fffbe6;
      border: 1px solid #ccc;
    }

    .receiver-row {
      text-align: center;
      font-weight: bold;
      background-color: #f2f2f2;
    }
  </style>
 <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- 로그인 페이지 -->
  <div id="login-container" class="login-container">
    <h2>📡 6사보도망 로그인</h2>
    <input type="text" id="username" placeholder="아이디" required />
    <input type="password" id="password" placeholder="비밀번호" required />
    <button onclick="login()">로그인</button>
    <div class="error-message" id="error-message"></div> <!-- 오류 메시지 표시 -->
  </div>


  <style>

/* 페이지 전반 배경을 옅은 분홍색으로 설정 */
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  background-color: #ffe6f0;
}

/* 작성 페이지 폭을 화면 전체로 유지 */
.login-container,
#service-container {
  width: calc(100% - 40px); /* body padding 20px씩 제외 */
  margin: 0 auto;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
}

    
    /* 로그인 박스 디자인 */
    .login-container {
      max-width: 400px;
      padding: 30px;
      background-color: rgba(0, 0, 0, 0.6);
      /* 반투명 검정색 배경 */
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
      text-align: center;
      color: white;
    }

    /* 타이틀 디자인 */
    .login-container h2 {
      color: #FF9800;
      /* 방송 시스템 색상, 주황색 */
      font-size: 24px;
      margin-bottom: 20px;
    }

    /* 인풋 박스 디자인 */
    .login-container input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #FF9800;
      /* 입력란 테두리 색상 주황색 */
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      background-color: #333;
      /* 입력란 배경 어두운 색 */
      color: white;
    }

    /* 로그인 버튼 디자인 */
    .login-container button {
      width: 100%;
      padding: 12px;
      background-color: #FF9800;
      /* 버튼 색상 주황색 */
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }

    /* 버튼 호버 효과 */
    .login-container button:hover {
      background-color: #FF5722;
      /* 버튼 호버 시 색상 변경 (어두운 주황색) */
    }

    /* 오류 메시지 디자인 */
    .error-message {
      color: red;
      margin-top: 10px;
    }
  </style>

  <div id="dateCounts" style="margin-top: 20px;"></div>
  
  <!-- 실시간 서비스 페이지 -->
  <div id="service-container" style="display: none;">
    <h1>📡 6사보도망 실시간 서비스</h1>
    <p id="currentUser" style="font-size: 18px; color: #333;">로그인된 사용자: </p> <!-- 로그인한 사용자 표시 -->
    <div class="button-container">
      <button class="send" onclick="sendAlarm()">🔔 알람</button>
      <button class="stop" onclick="stopAlarm()">⏹ 정지</button>
      <button class="add" onclick="addRow()">➕ 행 추가</button>
      <button class="delete" onclick="deleteRow()">🗑 행 삭제</button>
      <button class="save" onclick="saveData()">💾 저장</button>
      <button id="refreshButton" class="refresh">🔃 새로고침</button>
      <button class="logout" onclick="logout()">로그아웃</button>
      <button onclick="showAllHistory()">📜 전체 이력 보기</button>
    </div>

    <audio id="alarmSound" loop>
      <source src="{{ url_for('static', filename='alarm.mp3') }}" type="audio/mpeg">
      브라우저가 오디오를 지원하지 않습니다.
    </audio>

    <table id="logTable">
      <thead>
        <tr>
          <th>✔</th>
          <th rowspan="2">날짜</th>
          <th rowspan="2">올린시간</th>
          <th rowspan="2">내용</th>
          <th rowspan="2">송출사</th>
          <th colspan="6">수신사</th>
        </tr>
        <tr>
          <th></th>
          <th>KBS</th>
          <th>MBC</th>
          <th>SBS</th>
          <th>MBN</th>
          <th>YTN</th>
          <th>OBS</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <style>
    /* 테이블 배경을 하얀색으로 설정 */
    #logTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: white;
      /* 테이블 배경을 하얀색으로 설정 */
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
    }

    thead th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
      /* 짝수 번째 행의 배경을 연한 회색으로 설정 */
    }

    td[contenteditable] {
      background-color: #fffbe6;
      /* 편집 가능한 셀 배경색 */
      border: 1px solid #ccc;
    }
  </style>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>
