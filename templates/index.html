<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>📡 6사보도망 서비스 내역</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- ✅ 스타일시트도 static으로 이동 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- 로그인 페이지 -->
  <div id="login-container" class="login-container">
    <h2>📡 6사보도망 로그인</h2>
    <input type="text" id="username" placeholder="아이디" required />
    <input type="password" id="password" placeholder="비밀번호" required />
    <button onclick="login()">로그인</button>
    <div class="error-message" id="error-message"></div>
  </div>

  <div id="service-container" style="display: none;">
    <h1>📡 6사보도망 실시간 서비스</h1>
    <p id="currentUser" style="font-size: 18px; color: #333;">로그인된 사용자: </p>
    <div class="button-container">
      <button class="send" onclick="sendAlarm()">🔔 알람</button>
      <button class="stop" onclick="stopAlarm()">⏹ 정지</button>
      <button class="add" onclick="addRow()">➕ 행 추가</button>
      <button class="delete" onclick="deleteRow()">🗑 행 삭제</button>
      <button class="save" onclick="saveData()">💾 저장</button>
      <button id="refreshButton" class="refresh">🔃 새로고침</button>
      <button class="logout" onclick="logout()">로그아웃</button>
    </div>

    <!-- ✅ 알람 소리 static 경로로 수정 -->
    <audio id="alarmSound" loop>
      <source src="{{ url_for('static', filename='alarm.mp3') }}" type="audio/mpeg">
      브라우저가 오디오를 지원하지 않습니다.
    </audio>

    <table id="logTable">
      <thead>
        <tr>
          <th>✔</th>
          <th rowspan="2">날짜</th>
          <th rowspan="2">방송시간</th>
          <th rowspan="2">내용</th>
          <th rowspan="2">송출사</th>
          <th colspan="6">수신사</th>
        </tr>
        <tr>
          <th></th>
          <th>KBS</th>
          <th>MBC</th>
          <th>SBS</th>
          <th>MBN</th>
          <th>YTN</th>
          <th>OBS</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- ✅ 백그라운드 이미지 경로 수정 -->
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 0;
      margin: 0;
      height: 100vh;
      background-image: url('{{ url_for('static', filename='logo.png') }}');
      background-size: cover;
      background-position: center;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>

  <!-- ✅ 전체 JavaScript 함수 포함 -->
  <script>
    const firebaseConfig = {
      apiKey: "",
      authDomain: "sabodo-82fa8.firebaseapp.com",
      projectId: "sabodo-82fa8",
      storageBucket: "sabodo-82fa8.firebasestorage.app",
      messagingSenderId: "411843694800",
      appId: "1:411843694800:web:94e40d6ec9f05cdd60ced5",
      measurementId: "G-CKBERJMFMG"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const tableRef = db.collection("logTable");
    const alarmRef = db.collection("system").doc("alarmStatus");

    function checkLogin() {
      const currentUser = localStorage.getItem("username");
      if (currentUser) {
        document.getElementById("login-container").style.display = "none";
        document.getElementById("service-container").style.display = "block";
        document.getElementById("currentUser").innerText = `${currentUser} 님, 환영합니다!`;
        loadTable();
        listenToAlarmStatus();
      } else {
        document.getElementById("login-container").style.display = "block";
        document.getElementById("service-container").style.display = "none";
      }
    }

    function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const validUsers = {
        "itc": "itc",
        "kbs": "kbs",
        "mbc": "mbc",
        "sbs": "sbs",
        "ytn": "ytn",
        "mbn": "mbn",
        "obs": "obs"
      };

      if (validUsers[username] && validUsers[username] === password) {
        localStorage.setItem("username", username);
        checkLogin();
      } else {
        document.getElementById("error-message").innerText = "아이디나 비밀번호가 틀렸습니다.";
      }
    }

    function logout() {
      localStorage.removeItem("username");
      checkLogin();
    }

    function listenToAlarmStatus() {
      alarmRef.onSnapshot(doc => {
        const alarmStatus = doc.data();
        if (alarmStatus && alarmStatus.isAlarmActive) {
          document.getElementById("alarmSound").play();
        } else {
          document.getElementById("alarmSound").pause();
          document.getElementById("alarmSound").currentTime = 0;
        }
      });
    }

    function sendAlarm() {
      alarmRef.set({ isAlarmActive: true }).then(() => {
        console.log("알람이 울렸습니다.");
      });
    }

    function stopAlarm() {
      alarmRef.set({ isAlarmActive: false }).then(() => {
        console.log("알람이 정지되었습니다.");
      });
    }

    function loadTable() {
      const currentUser = localStorage.getItem("username");
      const receivers = ["KBS", "MBC", "SBS", "MBN", "YTN", "OBS"];

      tableRef.get().then(snapshot => {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        snapshot.forEach(doc => {
          const data = doc.data();
          const tr = document.createElement("tr");

          let shouldDisplayRow = true;
          receivers.forEach(rcv => {
            if (currentUser.toUpperCase() === rcv.toUpperCase() && data[rcv] && data[rcv].exclude === "제외!") {
              shouldDisplayRow = false;
            }
          });

          if (!shouldDisplayRow) {
            tr.style.display = "none";
          }

          tr.innerHTML = `
            <td><input type="checkbox" /></td>
            <td contenteditable="true" onblur="updateCell('${doc.id}', 'date', this.innerText)">${data.date || ''}</td>
            <td contenteditable="true" onblur="updateCell('${doc.id}', 'time', this.innerText)">${data.time || ''}</td>
            <td contenteditable="true" onblur="updateCell('${doc.id}', 'content', this.innerText)">${data.content || ''}</td>
            <td contenteditable="true" onblur="updateCell('${doc.id}', 'sender', this.innerText)">${data.sender || ''}</td>
            ${receivers.map(rcv => `
              <td>
                <button onclick="toggleAck('${doc.id}', '${rcv}')">${(data[rcv] && data[rcv].ack) || '확인!'}</button>
                <button onclick="toggleExclude(this, '${doc.id}', '${rcv}')" class="${(data[rcv] && data[rcv].exclude === '제외!') ? 'exclude-btn active' : 'exclude-btn'}">${(data[rcv] && data[rcv].exclude) || '제외'}</button>
              </td>
            `).join('')}
          `;
          tbody.appendChild(tr);
        });
      });
    }

    function updateCell(id, field, value) {
      tableRef.doc(id).update({ [field]: value }).then(() => loadTable());
    }

    function toggleAck(id, rcv) {
      const cellRef = tableRef.doc(id);
      cellRef.get().then(doc => {
        const data = doc.data();
        const current = (data[rcv] && data[rcv].ack) || '확인!';
        const updated = current === '확인!' ? '✅ 확인됨' : '확인!';
        cellRef.update({ [`${rcv}.ack`]: updated }).then(() => loadTable());
      });
    }

    function toggleExclude(btn, id, rcv) {
      const cellRef = tableRef.doc(id);
      cellRef.get().then(doc => {
        const data = doc.data();
        const current = (data[rcv] && data[rcv].exclude) || '제외';
        const updated = current === '제외' ? '제외!' : '제외';
        cellRef.update({
          [`${rcv}.exclude`]: updated,
          [`${rcv}.ack`]: '확인!'
        }).then(() => {
          loadTable();
          btn.classList.toggle('active');
        });
      });
    }

    function addRow() {
      const rowData = {
        date: '', time: '', content: '', sender: ''
      };
      const receivers = ["KBS", "MBC", "SBS", "MBN", "YTN", "OBS"];
      receivers.forEach(rcv => {
        rowData[rcv] = { ack: '확인!', exclude: '제외' };
      });
      tableRef.add(rowData).then(() => {
        loadTable();
      });
    }

    function saveData() {
      alert("저장되었습니다!");
    }

    function deleteRow() {
      tableRef.get().then(snapshot => {
        const rows = document.querySelectorAll("#logTable tbody tr");
        snapshot.docs.forEach((doc, index) => {
          if (rows[index].querySelector("input").checked) {
            doc.ref.delete().then(() => {
              loadTable();
            });
          }
        });
      });
    }

    document.addEventListener("DOMContentLoaded", checkLogin);
    setInterval(function () {
      window.location.reload();
    }, 60000);
  </script>

</body>
</html>
