<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>ğŸ“¡ 6ì‚¬ë³´ë„ë§ ì„œë¹„ìŠ¤ ë‚´ì—­</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- âœ… ìŠ¤íƒ€ì¼ì‹œíŠ¸ë„ staticìœ¼ë¡œ ì´ë™ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- ë¡œê·¸ì¸ í˜ì´ì§€ -->
  <div id="login-container" class="login-container">
    <h2>ğŸ“¡ 6ì‚¬ë³´ë„ë§ ë¡œê·¸ì¸</h2>
    <input type="text" id="username" placeholder="ì•„ì´ë””" required />
    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required />
    <button onclick="login()">ë¡œê·¸ì¸</button>
    <div class="error-message" id="error-message"></div>
  </div>

  <div id="service-container" style="display: none;">
    <h1>ğŸ“¡ 6ì‚¬ë³´ë„ë§ ì‹¤ì‹œê°„ ì„œë¹„ìŠ¤</h1>
    <p id="currentUser" style="font-size: 18px; color: #333;">ë¡œê·¸ì¸ëœ ì‚¬ìš©ì: </p>
    <div class="button-container">
      <button class="send" onclick="sendAlarm()">ğŸ”” ì•ŒëŒ</button>
      <button class="stop" onclick="stopAlarm()">â¹ ì •ì§€</button>
      <button class="add" onclick="addRow()">â• í–‰ ì¶”ê°€</button>
      <button class="delete" onclick="deleteRow()">ğŸ—‘ í–‰ ì‚­ì œ</button>
      <button class="save" onclick="saveData()">ğŸ’¾ ì €ì¥</button>
      <button id="refreshButton" class="refresh">ğŸ”ƒ ìƒˆë¡œê³ ì¹¨</button>
      <button class="logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- âœ… ì•ŒëŒ ì†Œë¦¬ static ê²½ë¡œë¡œ ìˆ˜ì • -->
    <audio id="alarmSound" loop>
      <source src="{{ url_for('static', filename='alarm.mp3') }}" type="audio/mpeg">
      ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </audio>

    <table id="logTable">
      <thead>
        <tr>
          <th>âœ”</th>
          <th rowspan="2">ë‚ ì§œ</th>
          <th rowspan="2">ë°©ì†¡ì‹œê°„</th>
          <th rowspan="2">ë‚´ìš©</th>
          <th rowspan="2">ì†¡ì¶œì‚¬</th>
          <th colspan="6">ìˆ˜ì‹ ì‚¬</th>
        </tr>
        <tr>
          <th></th>
          <th>KBS</th>
          <th>MBC</th>
          <th>SBS</th>
          <th>MBN</th>
          <th>YTN</th>
          <th>OBS</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- âœ… ë°±ê·¸ë¼ìš´ë“œ ì´ë¯¸ì§€ ê²½ë¡œ ìˆ˜ì • -->
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 0;
      margin: 0;
      height: 100vh;
      background-image: url('{{ url_for('static', filename='logo.png') }}');
      background-size: cover;
      background-position: center;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>

  <!-- âœ… ì „ì²´ JavaScript í•¨ìˆ˜ í¬í•¨ -->
  <script>
    const firebaseConfig = {
      apiKey: "",
      authDomain: "sabodo-82fa8.firebaseapp.com",
      projectId: "sabodo-82fa8",
      storageBucket: "sabodo-82fa8.firebasestorage.app",
      messagingSenderId: "411843694800",
      appId: "1:411843694800:web:94e40d6ec9f05cdd60ced5",
      measurementId: "G-CKBERJMFMG"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const tableRef = db.collection("logTable");
    const alarmRef = db.collection("system").doc("alarmStatus");

    function checkLogin() {
      const currentUser = localStorage.getItem("username");
      if (currentUser) {
        document.getElementById("login-container").style.display = "none";
        document.getElementById("service-container").style.display = "block";
        document.getElementById("currentUser").innerText = `${currentUser} ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
        loadTable();
        listenToAlarmStatus();
      } else {
        document.getElementById("login-container").style.display = "block";
        document.getElementById("service-container").style.display = "none";
      }
    }

    function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const validUsers = {
        "itc": "itc",
        "kbs": "kbs",
        "mbc": "mbc",
        "sbs": "sbs",
        "ytn": "ytn",
        "mbn": "mbn",
        "obs": "obs"
      };

      if (validUsers[username] && validUsers[username] === password) {
        localStorage.setItem("username", username);
        checkLogin();
      } else {
        document.getElementById("error-message").innerText = "ì•„ì´ë””ë‚˜ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
      }
    }

    function logout() {
      localStorage.removeItem("username");
      checkLogin();
    }

    function listenToAlarmStatus() {
      alarmRef.onSnapshot(doc => {
        const alarmStatus = doc.data();
        if (alarmStatus && alarmStatus.isAlarmActive) {
          document.getElementById("alarmSound").play();
        } else {
          document.getElementById("alarmSound").pause();
          document.getElementById("alarmSound").currentTime = 0;
        }
      });
    }

    function sendAlarm() {
      alarmRef.set({ isAlarmActive: true }).then(() => {
        console.log("ì•ŒëŒì´ ìš¸ë ¸ìŠµë‹ˆë‹¤.");
      });
    }

    function stopAlarm() {
      alarmRef.set({ isAlarmActive: false }).then(() => {
        console.log("ì•ŒëŒì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      });
    }

    function loadTable() {
      const currentUser = localStorage.getItem("username");
      const receivers = ["KBS", "MBC", "SBS", "MBN", "YTN", "OBS"];

      tableRef.get().then(snapshot => {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        snapshot.forEach(doc => {
          const data = doc.data();
          const tr = document.createElement("tr");

          let shouldDisplayRow = true;
          receivers.forEach(rcv => {
            if (currentUser.toUpperCase() === rcv.toUpperCase() && data[rcv] && data[rcv].exclude === "ì œì™¸!") {
              shouldDisplayRow = false;
            }
          });

          if (!shouldDisplayRow) {
            tr.style.display = "none";
          }

          tr.innerHTML = `
            <td><input type="checkbox" /></td>
            <td contenteditable="true" onblur="updateCell('${doc.id}', 'date', this.innerText)">${data.date || ''}</td>
            <td contenteditable="true" onblur="updateCell('${doc.id}', 'time', this.innerText)">${data.time || ''}</td>
            <td contenteditable="true" onblur="updateCell('${doc.id}', 'content', this.innerText)">${data.content || ''}</td>
            <td contenteditable="true" onblur="updateCell('${doc.id}', 'sender', this.innerText)">${data.sender || ''}</td>
            ${receivers.map(rcv => `
              <td>
                <button onclick="toggleAck('${doc.id}', '${rcv}')">${(data[rcv] && data[rcv].ack) || 'í™•ì¸!'}</button>
                <button onclick="toggleExclude(this, '${doc.id}', '${rcv}')" class="${(data[rcv] && data[rcv].exclude === 'ì œì™¸!') ? 'exclude-btn active' : 'exclude-btn'}">${(data[rcv] && data[rcv].exclude) || 'ì œì™¸'}</button>
              </td>
            `).join('')}
          `;
          tbody.appendChild(tr);
        });
      });
    }

    function updateCell(id, field, value) {
      tableRef.doc(id).update({ [field]: value }).then(() => loadTable());
    }

    function toggleAck(id, rcv) {
      const cellRef = tableRef.doc(id);
      cellRef.get().then(doc => {
        const data = doc.data();
        const current = (data[rcv] && data[rcv].ack) || 'í™•ì¸!';
        const updated = current === 'í™•ì¸!' ? 'âœ… í™•ì¸ë¨' : 'í™•ì¸!';
        cellRef.update({ [`${rcv}.ack`]: updated }).then(() => loadTable());
      });
    }

    function toggleExclude(btn, id, rcv) {
      const cellRef = tableRef.doc(id);
      cellRef.get().then(doc => {
        const data = doc.data();
        const current = (data[rcv] && data[rcv].exclude) || 'ì œì™¸';
        const updated = current === 'ì œì™¸' ? 'ì œì™¸!' : 'ì œì™¸';
        cellRef.update({
          [`${rcv}.exclude`]: updated,
          [`${rcv}.ack`]: 'í™•ì¸!'
        }).then(() => {
          loadTable();
          btn.classList.toggle('active');
        });
      });
    }

    function addRow() {
      const rowData = {
        date: '', time: '', content: '', sender: ''
      };
      const receivers = ["KBS", "MBC", "SBS", "MBN", "YTN", "OBS"];
      receivers.forEach(rcv => {
        rowData[rcv] = { ack: 'í™•ì¸!', exclude: 'ì œì™¸' };
      });
      tableRef.add(rowData).then(() => {
        loadTable();
      });
    }

    function saveData() {
      alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }

    function deleteRow() {
      tableRef.get().then(snapshot => {
        const rows = document.querySelectorAll("#logTable tbody tr");
        snapshot.docs.forEach((doc, index) => {
          if (rows[index].querySelector("input").checked) {
            doc.ref.delete().then(() => {
              loadTable();
            });
          }
        });
      });
    }

    document.addEventListener("DOMContentLoaded", checkLogin);
    setInterval(function () {
      window.location.reload();
    }, 60000);
  </script>

</body>
</html>
