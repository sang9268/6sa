<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>📡 6사보도 서비스 내역</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "",
      authDomain: "sabodo-82fa8.firebaseapp.com",
      projectId: "sabodo-82fa8",
      storageBucket: "sabodo-82fa8.firebasestorage.app",
      messagingSenderId: "411843694800",
      appId: "1:411843694800:web:94e40d6ec9f05cdd60ced5",
      measurementId: "G-CKBERJMFMG"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const tableRef = db.collection("logTable");
    const alarmRef = db.collection("system").doc("alarmStatus"); // Firestore에서 알람 상태를 관리

	let isShowingAll = false; // false = 기본 보기
	let isAlarmActive = false; // 기본값: 정지 상태


    // 로그인 상태 확인 함수
function checkLogin() {
  const currentUser = localStorage.getItem("username");

  if (currentUser) {
    document.getElementById("login-container").style.display = "none";
    document.getElementById("service-container").style.display = "block";
    document.getElementById("currentUser").innerText = `${currentUser} 님`;

	const senderSelect = document.getElementById("inputSender");
	    if (senderSelect) {
	      // SBS_NQC, SBS_ING 계정도 SBS로 간주하여 기본값 설정
	      let defaultSender = currentUser;
	      if (["SBS_NQC", "SBS_ING"].includes(currentUser)) {
	        defaultSender = "SBS";
	      }
	      senderSelect.value = defaultSender.toUpperCase();
	    }
    loadTable();
    listenToAlarmStatus();


    // ✅ 계정별 권한 설정 (확장 가능)
	const userPermissions = {
	  SBS_ADMIN: { backup: true, alarm: true, excel: true, canRegister: true, canDelete: true },
	  SBS: { backup: false, alarm: true, excel: true, canRegister: false, canDelete: false },
	  SBS_NQC: { backup: false, alarm: true, excel: true, canRegister: false, canDelete: false },
	  SBS_ING: { backup: false, alarm: true, excel: true, canRegister: false, canDelete: false },
	  KBS: { backup: false, alarm: true, excel: true, canRegister: true, canDelete: true },
	  MBC: { backup: false, alarm: true, excel: true, canRegister: true, canDelete: true },
	  YTN: { backup: false, alarm: true, excel: true, canRegister: true, canDelete: true },
	  "LGU+": { backup: true, alarm: true, excel: true, canRegister: true, canDelete: true },
	  OBS: { backup: false, alarm: true, excel: true, canRegister: true, canDelete: true }
	};

	let normalizedUser = currentUser;
	if (["SBS_NQC", "SBS_ING"].includes(currentUser)) {
	  normalizedUser = "SBS";
	}
	
	const permissions = userPermissions[currentUser] || userPermissions[normalizedUser] || { canRegister: true, canDelete: true };


    // 내용 등록 버튼 제어
    const registerBtn = document.querySelector("button[onclick='openContentPopup()']");
    if (registerBtn) {
      registerBtn.disabled = !permissions.canRegister;
      registerBtn.style.opacity = permissions.canRegister ? "1" : "0.5";
      registerBtn.style.cursor = permissions.canRegister ? "pointer" : "not-allowed";
      registerBtn.title = permissions.canRegister ? "" : "이 계정은 내용 등록 권한이 없습니다.";
    }

    // 행 삭제 버튼 제어 (table 내 각 행의 삭제 버튼도 비활성화 처리)
    // 행 삭제 버튼은 loadTable()에서 매번 생성하므로, 여기서는 전체 테이블 행 삭제 버튼을 제어하는 버튼이 따로 있다면 제어해주고,
    // 아니면 loadTable()에서 권한 체크 후 disabled 처리하도록 해야 합니다.
    // 예시로 id="deleteRowButton"가 있다면 다음과 같이 처리 가능:
    
    const deleteRowBtn = document.getElementById("deleteRowButton");
    if (deleteRowBtn) {
      deleteRowBtn.disabled = !permissions.canDelete;
      deleteRowBtn.style.opacity = permissions.canDelete ? "1" : "0.5";
      deleteRowBtn.style.cursor = permissions.canDelete ? "pointer" : "not-allowed";
      deleteRowBtn.title = permissions.canDelete ? "" : "이 계정은 행 삭제 권한이 없습니다.";
    }
   
	  
    // ✅ 자료송출 내역 백업 버튼 제어
    const backupBtn = document.getElementById("backupButton");
    if (backupBtn && permissions.backup === false) {
      backupBtn.disabled = true;
      backupBtn.style.backgroundColor = "#ccc";
      backupBtn.style.cursor = "not-allowed";
      backupBtn.title = "이 계정은 백업 권한이 없습니다.";
    }

    // ✅ 엑셀 저장 버튼 제어
    const excelBtn = document.querySelector("button[onclick='downloadAsExcel()']");
    if (excelBtn && permissions.excel === false) {
      excelBtn.disabled = true;
      excelBtn.style.backgroundColor = "#ccc";
      excelBtn.style.cursor = "not-allowed";
      excelBtn.title = "이 계정은 엑셀 저장 권한이 없습니다.";
    }

    // ✅ 알람 전송 버튼 제어
    const alarmBtn = document.getElementById("alarmToggleButton");
    if (alarmBtn && permissions.alarm === false) {
      alarmBtn.disabled = true;
      alarmBtn.style.backgroundColor = "#ccc";
      alarmBtn.style.cursor = "not-allowed";
      alarmBtn.title = "이 계정은 알람 전송 권한이 없습니다.";
    }

  } else {
    document.getElementById("login-container").style.display = "block";
    document.getElementById("service-container").style.display = "none";
  }
}

function triggerPopupForAllUsers() {
  alarmRef.set({
    isAlarmActive: true,
    alarmMessage: "📡 6사보도 자료송출이 등록되었습니다!",
    timestamp: Date.now()
  });
}


function deleteAllhides() {
  tableRef
    .orderBy("createdAt", "desc")
    .get()
    .then(snapshot => {
      const docs = snapshot.docs;

      const hidePromises = [];
      for (let i = 0; i < docs.length; i++) {
        const data = docs[i].data();
        
        // 고정 행 내용과 같은 경우 제외
        if (data.content === "🛠 내용 등록 박스를 입력하시고 등록버튼을 누르시면 자동으로 입력됩니다.(첫 행은 고정으로 사용하겠습니다.)") {
          continue; // 고정 행은 숨기지 않음
        }

        hidePromises.push(docs[i].ref.update({ hidden: true }));
      }

      Promise.all(hidePromises).then(() => {
        loadTable();
        alert("모든 행을 숨겼습니다 (고정 행은 유지됩니다).");
      });
    });
}

let audioCtx;
let oscillator;
let gainNode;
let alarmInterval;

function initializeAudioContext() {
  if (!audioCtx || audioCtx.state === 'closed') {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}


// 🔔 알람 버튼 클릭 시 전체 알림 활성화 (모든 계정에 적용)
function toggleAlarm() {
  const username = localStorage.getItem("username");
  if (!username) return;

  localStorage.removeItem(`alarmAcknowledged_${username}`); // 알림 초기화
  sendAlarm(); // Firestore의 전체 알람 상태를 true로 설정
  alert("📢 전체 사용자에게 자료송출 알림을 전송했습니다.");
}

function playSoftTone() {
  if (!audioCtx) return;

  oscillator = audioCtx.createOscillator();
  gainNode = audioCtx.createGain();

  oscillator.type = 'sine';
  oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // 부드러운 A음

  gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime); // 볼륨 설정

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.start();
  oscillator.stop(audioCtx.currentTime + 1.0); // 1초 재생
}

function playLoopingBeep() {
  stopLoopingBeep(); // 중복 방지
  alarmInterval = setInterval(playSoftTone, 1500); // 1.5초 간격 반복
}

function stopLoopingBeep() {
  clearInterval(alarmInterval);
  if (oscillator) {
    try { oscillator.stop(); } catch (e) {}
    oscillator.disconnect();
  }
  if (gainNode) gainNode.disconnect();
}

// 여러 팝업 생성 함수
function createAlarmPopup(message, popupId, docId) {
  const container = document.getElementById("alarmPopupContainer");

  const popup = document.createElement("div");
  popup.id = popupId;
  popup.style.background = "white";
  popup.style.padding = "20px";
  popup.style.borderRadius = "12px";
  popup.style.boxShadow = "0 0 12px rgba(0,0,0,0.3)";
  popup.style.marginBottom = "10px";
  popup.style.textAlign = "center";

  popup.innerHTML = `
    <p class="alarm-text" style="font-size: 18px; font-weight: bold;">${message.replace(/\n/g, "<br>")}</p>
    <p>확인을 누르면 이 계정에서만 알림이 정지됩니다.</p>
    <button style="margin-top: 20px; padding: 10px 20px; font-size: 16px;" onclick="acknowledgeSingleAlarm('${popupId}', '${docId}')">✅ 확인</button>
  `;

  container.appendChild(popup);
}

// 개별 팝업 닫기 함수
function acknowledgeSingleAlarm(popupId, docId) {
  // 1. 팝업 닫기
  const popup = document.getElementById(popupId);
  if (popup) popup.remove();

  // 2. 로그인 사용자 확인
  const username = localStorage.getItem("username");
  if (!username) {
    console.warn("로그인 정보가 없어 알림 확인 처리를 할 수 없습니다.");
    return;
  }

  // 3. SBS_NQC 계정은 확인 상태 갱신하지 않음
  if (username === "SBS_NQC") {
    console.log("SBS_NQC 계정은 ack 상태를 갱신하지 않습니다.");
    stopLoopingBeep();
    if (audioCtx && audioCtx.state === "suspended") {
      audioCtx.resume();
    }
    return;
  }

  // 4. 문서 ID 유효성 확인
  if (!docId) {
    console.warn("문서 ID가 없어 확인 상태를 업데이트할 수 없습니다.");
    return;
  }

  // 5. 계정명을 수신사 이름으로 정규화
  const normalizedUser = ["SBS_ING"].includes(username) ? "SBS" : username.toUpperCase();

  // 6. 해당 수신사의 ack 상태만 '확인완료'로 갱신
  const updateData = {};
  updateData[`${normalizedUser}.ack`] = "확인완료";

  tableRef.doc(docId).update(updateData)
    .then(() => {
      loadTable(); // UI 갱신
    })
    .catch(err => {
      console.error("ack 상태 업데이트 실패:", err);
    });

  // 7. 알람음 정지 및 오디오 컨텍스트 재개
  stopLoopingBeep();
  if (audioCtx && audioCtx.state === "suspended") {
    audioCtx.resume();
  }
}
	  

function listenToAlarmStatus() {
  alarmRef.onSnapshot(doc => {
    const alarmStatus = doc.data();
    const username = localStorage.getItem("username");
    if (!alarmStatus || !username) return;

    const acknowledgedKey = `alarmAcknowledged_${username}`;
    const acknowledgedAt = parseInt(localStorage.getItem(acknowledgedKey) || "0", 10);
    const now = Date.now();
    const alarmStart = alarmStatus.timestamp || now;

    // 아직 확인하지 않았고 5분 이내면 알람 표시
    if (alarmStatus.isAlarmActive && (!acknowledgedAt || acknowledgedAt < alarmStart)) {
        initializeAudioContext();
        playLoopingBeep();
        showAlarmPopup(alarmStatus.alarmMessage || "📡 자료 송출 알림이 발생했습니다!");
    } else {
      // hideAlarmPopup();
      stopLoopingBeep();
    }
  });
}


function toggleBroadcastStatus(button) {
  const tr = button.closest("tr");
  const rowId = tr.getAttribute("data-row-id");
  const current = button.innerText;

  let nextState, color;
  if (current === "송출전") {
    nextState = "송출중";
    color = "#ffcccc";  // 연빨강
  } else if (current === "송출중") {
    nextState = "송출후";
    color = "#dcdcdc";  // 회색
  } else {
    nextState = "송출전";
    color = "#fffbe6";  // 연노랑
  }

  // 버튼 텍스트 및 행 색상 변경
  button.innerText = nextState;
  tr.style.backgroundColor = color;

  // Firestore에 상태 업데이트
  if (rowId) {
    tableRef.doc(rowId).update({
      broadcastStatus: nextState
    });
  }
}


	  
function deleteAllRows() {
  if (!confirm("정말 모든 행을 완전히 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) return;

  tableRef.get().then(snapshot => {
    const deletePromises = [];
    snapshot.forEach(doc => {
      const data = doc.data();

      // ✅ 고정행은 삭제하지 않음
      if (data.content === "🛠 내용 등록 박스를 입력하시고 등록버튼을 누르시면 자동으로 입력됩니다.(첫 행은 고정으로 사용하겠습니다.)") {
        return; // 삭제 제외
      }

      deletePromises.push(doc.ref.delete());
    });

    return Promise.all(deletePromises);
  }).then(() => {
    alert("모든 행이 완전히 삭제되었습니다 (고정 행 제외).");
    loadTable();
  }).catch(error => {
    console.error("삭제 오류:", error);
    alert("삭제 중 오류가 발생했습니다.");
  });
}



  // 건수 보기 함수
  function openAllView() {
    window.open("allview.html", "_blank", "width=1200,height=800");
  }

// 전체 보기 함수
function openAllRows() {
    // hidden 여부에 관계없이 전체 로우 보여주기
    tableRef
      .orderBy('createdAt', 'desc')
      .get()
      .then(snapshot => {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";
        const docs = snapshot.docs;
        const total = docs.length;

        docs.forEach((doc, index) => {
          const data = doc.data();
          const rowId = doc.id;
          const tr = document.createElement("tr");
          tr.setAttribute("data-row-id", rowId);
          tr.innerHTML = `
            <td>${total - index}</td>
            <td>${data.date || ''}</td>
            <td>${data.time || ''}</td>
            <td>${data.content || ''}</td>
            <td>${data.sender || ''}</td>
            <td colspan="6">숨김 여부: ${data.hidden ? '✅ 숨김' : '❌ 표시중'}</td>
	    <td>
	    <button onclick="deleteRowById('${doc.id}')">행 삭제</button>
	    </td>
          `;
          tbody.appendChild(tr);
        });
      });

  }

function downloadAsExcel() {
  const table = document.getElementById("logTable");
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb, ws, "6사보도망");

  // ✅ 오늘 날짜 구하기 (YYYY-MM-DD 형식)
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  const todayStr = `${yyyy}-${mm}-${dd}`;

  // ✅ 파일명에 날짜 추가
  XLSX.writeFile(wb, `6사보도망_서비스내역_${todayStr}.xlsx`);
}


    // 로그인 함수
function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;

  fetch("static/users.json")  // ✅ users.json 경로 주의!
    .then(response => {
      if (!response.ok) throw new Error("계정 정보를 불러올 수 없습니다.");
      return response.json();
    })
    .then(users => {
      const user = users[username];

      if (!user) {
        document.getElementById("error-message").innerText = "존재하지 않는 계정입니다.";
        return;
      }

      if (user.password !== password) {
        document.getElementById("error-message").innerText = "비밀번호가 틀렸습니다.";
        return;
      }

      if (!user.enabled) {
        document.getElementById("error-message").innerText = "비활성화된 계정입니다.";
        return;
      }

      // ✅ 로그인 성공
      localStorage.setItem("username", username);
      localStorage.setItem("userRole", user.role);
      checkLogin();
    })
    .catch(err => {
      console.error("로그인 오류:", err);
      document.getElementById("error-message").innerText = "로그인 오류가 발생했습니다.";
    });
}


    // 로그아웃 함수
    function logout() {
      localStorage.removeItem("username");
      checkLogin();
    }

    /**
 * 내용 셀 수정 후 호출됩니다.
 * @param {string} id    - Firestore 문서 ID
 * @param {string} text  - 입력된 내용
 */
function onContentChange(id, text) {
  // 내용이 비어있으면 아무 것도 안 함
  if (!text.trim()) return;

  const now = new Date();
  // YYYY-MM-DD 포맷
  const date = [
    now.getFullYear(),
    String(now.getMonth() + 1).padStart(2, '0'),
    String(now.getDate()).padStart(2, '0')
  ].join('-');
  // HH:MM:SS 포맷
  const time = [
    String(now.getHours()).padStart(2, '0'),
    String(now.getMinutes()).padStart(2, '0'),
    String(now.getSeconds()).padStart(2, '0')
  ].join(':');

  // Firestore에 한꺼번에 업데이트
  tableRef.doc(id).update({
    content: text,
    date: date,
    time: time
  }).then(() => {
    loadTable();  // UI 새로고침
  });
}

function showAlarmPopup(message) {
  const popup = document.getElementById("alarmPopup");
  const textEl = popup.querySelector(".alarm-text");
  if (textEl) textEl.innerHTML = message.replace(/\n/g, "<br>");
  popup.style.display = "block";
}


function hideAlarmPopup() {
  document.getElementById("alarmPopup").style.display = "none";
}

function acknowledgeAlarm() {
  const username = localStorage.getItem("username");
  if (!username) return;

  const now = Date.now();
  localStorage.setItem(`alarmAcknowledged_${username}`, now.toString());

  hideAlarmPopup();
  stopLoopingBeep();
  if (audioCtx && audioCtx.state === "suspended") {
    audioCtx.resume();
  }
}



	  

    // 알람 시작 함수
    function sendAlarm() {
      alarmRef.set({isAlarmActive: true}).then(() => {
        console.log("알람이 울렸습니다.");
      });
    }

    // 알람 정지 함수
    function stopAlarm() {
      alarmRef.set({isAlarmActive: false}).then(() => {
        console.log("알람이 정지되었습니다.");
      });
    }

// 데이터 로드 함수
function loadTable() {
      const dateCounts = {}; // 이 줄을 loadTable() 함수 맨 위에 추가
      const currentUser = localStorage.getItem("username"); // 로그인된 사용자
      const currentUserUpper = (currentUser || "").toUpperCase();
      const normalizedCurrentUser = ["SBS", "SBS_NQC", "SBS_ING"].includes(currentUser) ? "SBS" : currentUser;
      const receivers = ["KBS", "MBC", "SBS", "MBN", "YTN", "OBS"];

	tableRef
    	.orderBy('createdAt','desc')   // 생성된 순서(오래된 것부터)로 정렬
  	  .get()
  	  .then(snapshot => {
	const docs = snapshot.docs.filter(doc => !doc.data().hidden); // hidden이 true인 문서 제외
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = ""; // 테이블 초기화

	     const userPermissions = {
	    SBS: { canDelete: false },
	    SBS_NQC: { canDelete: false },
	    SBS_ING: { canDelete: false },
	    // ...다른 계정 권한 정의...
	  };
	  const permissions = userPermissions[currentUser] || { canRegister: true, canDelete: true };

    const total = docs.length;  // ✅ 수정: 전체 문서 수가 아닌 필터링된 문서 수로
    docs.forEach((doc, index) => {
      const data = doc.data();
      const rowId = doc.id;

          const tr = document.createElement("tr");
          tr.setAttribute("data-row-id", rowId);  // 행 ID를 data-row-id로 설정

	// ✅ 상태에 따라 배경색 지정
	const status = data.broadcastStatus || "송출전";
	let bgColor = "#fffbe6"; // 기본 송출전
	if (status === "송출중") bgColor = "#ffcccc";
	else if (status === "송출후") bgColor = "#dcdcdc";
	tr.style.backgroundColor = bgColor;


          // 수신사별로 제외 상태를 체크하여, 해당 수신사에서 제외된 행만 숨김
        //  let shouldDisplayRow = true;

        //  receivers.forEach((name, idx) => {
            // 로그인된 계정이 해당 수신사일 경우, 대소문자 구분 없이 비교
         //   if (currentUser.toUpperCase() === name.toUpperCase() && data[name] && data[name].exclude === "제외") {
        //      shouldDisplayRow = false;  // 해당 수신사에서 제외된 경우 해당 행을 숨기도록 설정
       //     }
        //  });

          // 행을 숨기지 않도록 설정
      //    if (!shouldDisplayRow) {
       //     tr.style.display = "none";  // 해당 수신사에서 제외된 경우 해당 행을 숨김
      //    }

          tr.innerHTML = `
  	  <td>${total - index}</td>
	  <td>${data.date || ''}</td>
	  <td>${data.time || ''}</td>
	  <td>${data.sender || ''}</td>
	  <td>${data.content || ''}</td>

  ${receivers.map(rcv => {
    const ackText = (data[rcv] && data[rcv].ack) || '미확인';
    const excludeText = (data[rcv] && data[rcv].exclude) || '포함';

    const ackClass = ackText === '확인완료' ? 'ack-confirmed' : 'ack-pending';
    // 본인 계정 수신사이면서 미확인 상태일 때만 깜빡임 적용
   const blinkClass = (ackText !== '확인완료' && rcv === normalizedCurrentUser) ? 'blink' : '';

    return `
      <td>
     	 <span class="ack-text ${ackClass} ${blinkClass}">${ackText}</span>
      </td>
      <td>
         <span class="exclude-text">${excludeText}</span>
      </td>
    `;
  }).join('')}
  <td>
   <button onclick="deleteRowById('${doc.id}')" ${permissions.canDelete ? '' : 'disabled style="opacity:0.5;cursor:not-allowed"'}>행 삭제</button>
  </td>

          `;
          tbody.appendChild(tr);
          // ⭐ 날짜별 건수 세기
          if (data.date) {
            if (dateCounts[data.date]) {
              dateCounts[data.date]++;
            } else {
              dateCounts[data.date] = 1;
            }
          }

        index++;  // ✅ 카운터 증가
        });
		// 고정된 첫 행 추가
		const fixedRow = document.createElement("tr");
		fixedRow.innerHTML = `
		  <td>고정</td>
		  <td>2025-xx-xx</td>
		  <td>00:00:00</td>
    		  <td>LGU+</td>
		  <td>🛠 내용 등록 박스를 입력하시고 등록버튼을 누르시면 자동으로 입력됩니다.(첫 행은 고정으로 사용하겠습니다.)</td>
		  <td colspan="13" style="color:blue;">수신사에서는 내용 확인 시 확인버튼을 눌러주세요. / 수신버튼은 제외할 타 방송사만 눌러주세요.</td>
		`;
    		tbody.appendChild(fixedRow);

		// 여기 추가
		applyExcludeStyles();
      });
    }

function applyExcludeStyles() {
  document.querySelectorAll('.exclude-text').forEach(el => {
    const text = el.textContent.trim();
    el.classList.remove('exclude-include', 'exclude-exclude'); // 기존 클래스 초기화

    if (text === '포함') {
      el.classList.add('exclude-include');
    } else if (text === '제외') {
      el.classList.add('exclude-exclude');
    }
  });
}
	  
	  
 	function toggleView() {
	  const btn = document.getElementById("toggleViewButton");
	
	  if (isShowingAll) {
	    // 기본 보기로 전환
	    loadTable();
	    btn.innerText = "📋 기본 보기";
	    isShowingAll = false;
	  } else {
	    // 전체 보기로 전환
	    openAllRows();
	    btn.innerText = "📄 전체 보기";
	    isShowingAll = true;
	  }
	}

    // 셀 업데이트 함수
    function updateCell(id, field, value) {
      tableRef.doc(id).update({[field]: value}).then(() => loadTable());
    }

    // 확인 상태 토글
    function toggleAck(id, rcv) {
      const cellRef = tableRef.doc(id);
      cellRef.get().then(doc => {
        const data = doc.data();
        const current = (data[rcv] && data[rcv].ack) || '미확인';
        const updated = current === '미확인' ? '확인완료' : '미확인';
        cellRef.update({[`${rcv}.ack`]: updated}).then(() => {
          loadTable();
        });
      });
    }


    // 행 추가 함수
    function addRow() {
      const rowData = {
        date: '', time: '', content: '', sender: '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
	hidden: false,  // ✅ 숨김 여부
  	broadcastStatus: "송출전",  // ✅ 버튼 상태 기본값
      };

      const receivers = ["KBS", "MBC", "SBS", "MBN", "YTN", "OBS"];
      receivers.forEach(rcv => {
        rowData[rcv] = {ack: '미확인', exclude: '제외'};
      });
      tableRef.add(rowData).then(() => {
        loadTable();
      });
    }

    function saveData() {
      alert("저장되었습니다!");
    }

function openContentPopup() {
  document.getElementById("contentPopup").style.display = "block";
}

function closeContentPopup() {
  document.getElementById("contentPopup").style.display = "none";
}


function registerContent() {
  const content = document.getElementById("inputContent").value.trim();
  const sender = document.getElementById("inputSender").value;
  const checkboxes = document.querySelectorAll("input[type='checkbox']:checked");

  if (!content || !sender) {
    alert("내용과 송출사를 입력하세요.");
    return;
  }

  // 현재 날짜 및 시간 계산
  const now = new Date();
  const date = [
    now.getFullYear(),
    String(now.getMonth() + 1).padStart(2, '0'),
    String(now.getDate()).padStart(2, '0')
  ].join('-');
  const time = [
    String(now.getHours()).padStart(2, '0'),
    String(now.getMinutes()).padStart(2, '0'),
    String(now.getSeconds()).padStart(2, '0')
  ].join(':');

  const rowData = {
    date: date,
    time: time,
    content: content,
    sender: sender,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    hidden: false,
    broadcastStatus: "송출전"
  };
	
  const currentUser = localStorage.getItem("username")?.toUpperCase();  // 로그인한 계정
  const receivers = ["KBS", "MBC", "SBS", "MBN", "YTN", "OBS"];
  receivers.forEach(rcv => {
  const isSender = rcv === sender;                 // select box로 선택한 송출사
  const isCurrentUser = rcv === currentUser;       // 현재 로그인한 계정
  const isIncludedChecked = [...checkboxes].some(cb => cb.value === rcv);


// 송출사 또는 로그인 계정은 항상 포함
const isIncluded = isSender || isCurrentUser || isIncludedChecked;

  rowData[rcv] = {
    ack: "미확인",
    exclude: isIncluded ? "포함" : "제외"
  };
  });

tableRef.add(rowData).then((docRef) => {
        const docId = docRef.id;  // 새로 생성된 문서 ID 얻기
	const popupId = `alarm_${Date.now()}`;  // 고유 팝업 ID 생성
	const popupMessage = `📡 6사보도 자료송출이 등록되었습니다!
	📑 내용: ${content}
	📤 송출사: ${sender}`;
	
createAlarmPopup(popupMessage, popupId, docId);
	
   alarmRef.set({
    isAlarmActive: true,
    alarmMessage: popupMessage,
    timestamp: Date.now()
  });

  loadTable();
  document.getElementById("inputContent").value = "";
});

}


function deleteRowById(id) {
  if (confirm("정말 이 행을 삭제하시겠습니까?")) {
    tableRef.doc(id).delete().then(() => {
      alert("삭제되었습니다.");
      location.reload(); // 페이지 새로고침
    }).catch(error => {
      console.error("삭제 중 오류:", error);
      alert("삭제 중 오류가 발생했습니다.");
    });
  }
}
	  	  

    // 행 삭제 함수
function deleteRow() {
  const checkedBoxes = document.querySelectorAll("#logTable tbody input[type='checkbox']:checked");
  const deletePromises = [];

  checkedBoxes.forEach(box => {
    const id = box.getAttribute("data-id");
    const row = box.closest("tr");
    const isFixedRow = row && row.innerText.includes("🛠 내용 등록 박스를 입력하시고 등록버튼을 누르시면 자동으로 입력됩니다.(첫 행은 고정으로 사용하겠습니다.)");

    if (!isFixedRow && id) {
      deletePromises.push(tableRef.doc(id).delete());
    }
  });

  Promise.all(deletePromises).then(() => {
    loadTable();
  });
}


    // 페이지 로딩 시 로그인 상태 확인
    document.addEventListener("DOMContentLoaded", checkLogin);

document.addEventListener("DOMContentLoaded", function () {
  const refreshButton = document.getElementById("refreshButton");
  if (refreshButton) {
    refreshButton.addEventListener("click", function () {
      window.location.reload(); // 수동 새로고침
    });
  }


  // ✅ 접속 직후부터 1분 간격 자동 새로고침
  setInterval(function () {
    window.location.reload();
  }, 60000); // 60000ms = 1분
});

  </script>
  <style>

    h1 {
      text-align: center;
    }

    .button-container {
      text-align: center;
      margin-bottom: 20px;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .send,
    .stop,
    .add,
    .delete,
    .save,
    .refresh,
    .logout {
      background-color: #2196F3;
      color: white;
    }

    .send {
      background-color: #FF9800;
    }

    .stop {
      background-color: #f44336;
    }

    .add,
    .delete,
    .save {
      background-color: #4CAF50;
    }

    .exclude-btn.active {
      background-color: #f44336;
      color: white;
    }

    .exclude-btn {
      background-color: #2196F3;
      color: white;
    }

    /* 모든 테이블 버튼 크기 축소 */
#logTable td button {
  padding: 6px 12px;
  font-size: 1rem;
  line-height: 1.4;
  min-width: 0;          /* 최소 너비 제한 해제 */
}

/* 1~4열 헤더만 글자 크기 및 굵기 키우기 */
#logTable th:nth-child(-n+4) {
  font-size: 1.4rem;
}

#logTable th[colspan="12"] {
  font-size: 1.4rem;
}  
	  
    /* ‘내용’ 입력 칼럼(테이블 5번째 칼럼) 글자 크게 */
#logTable td:nth-child(5),
#logTable th:nth-child(5) {
  font-size: 1.4rem;    /* 원하시는 크기로 조정하세요 */
  line-height: 1.4;     /* 필요시 줄간격도 조절 */
}

    .logout {
      background-color: #9C27B0;
    }

    .login-container {
      max-width: 400px;
      margin: 0 auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .login-container input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .login-container button {
      width: 100%;
      padding: 12px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .login-container button:hover {
      background-color: #1976D2;
    }

    .error-message {
      color: red;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
    }

    thead th {
      background-color: #f2f2f2;
      font-weight: bold;
    }


    td[contenteditable] {
      border: 1px solid #ccc;
    }

    .receiver-row {
      text-align: center;
      font-weight: bold;
      background-color: #f2f2f2;
    }
  </style>
 <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- 로그인 페이지 -->
   <div id="login-container" class="login-container" style="display: none;">
    <h2>📡 6사보도망 로그인</h2>
    <input type="text" id="username" placeholder="아이디" required />
    <input type="password" id="password" placeholder="비밀번호" required />
    <button onclick="login()">로그인</button>
    <div class="error-message" id="error-message"></div> <!-- 오류 메시지 표시 -->
  </div>

<style>
  /* 수신사 로고 관련 스타일 */

  /* 🔽 여기 아래에 추가 */
  input[type="text"], select {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ffb6c1;
    border-radius: 6px;
    font-size: 16px;
    background-color: #fffafd;
    box-sizing: border-box;
  }

  input[type="text"]:focus,
  select:focus {
    outline: none;
    border-color: #ff69b4;
    box-shadow: 0 0 6px rgba(255, 105, 180, 0.5);
  }

  input[type="checkbox"] {
    accent-color: #ff69b4;
    transform: scale(1.2);
    margin-right: 4px;
  }
</style>

	

  <style>

	/* 페이지 전반 배경을 옅은 분홍색으로 설정 */
	body {
	  font-family: Arial, sans-serif;
	  padding: 20px;
	  background-color: #ffe6f0;
	}
	
	/* 작성 페이지 폭을 화면 전체로 유지 */
	.login-container,
	#service-container {
	  width: calc(100% - 40px); /* body padding 20px씩 제외 */
	  margin: 0 auto;
	  background: #fff;
	  padding: 20px;
	  border-radius: 8px;
	}

	.danger-button {
	  color: red;
	  font-weight: bold;
	}
    
    /* 로그인 박스 디자인 */
    .login-container {
      max-width: 400px;
      padding: 30px;
      background-color: rgba(0, 0, 0, 0.6);
      /* 반투명 검정색 배경 */
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
      text-align: center;
      color: white;
    }

	/* 🔒 제목, 버튼 고정 */
	.header-fixed {
	  position: sticky;
	  top: 0;
	  background-color: #ffffff;
	  z-index: 1000;
	  padding-top: 10px;
	  padding-bottom: 10px;
	}
	
	/* 🔒 테이블 헤더 고정용 래퍼 */
	.table-wrapper {
	  max-height: 900px;  /* 필요 시 조절 가능 */
	  overflow-y: auto;
	  background-color: #ffffff; 
	}
	
	/* 🔒 테이블 헤더(2줄) 고정 */
	#logTable thead tr:nth-child(1),
	#logTable thead tr:nth-child(2) {
	  position: sticky;
	  top: 0;
	  background-color: white;
	  z-index: 10;
	}

	  
    /* 타이틀 디자인 */
    .login-container h2 {
      color: #FF9800;
      /* 방송 시스템 색상, 주황색 */
      font-size: 24px;
      margin-bottom: 20px;
    }

    /* 인풋 박스 디자인 */
    .login-container input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #FF9800;
      /* 입력란 테두리 색상 주황색 */
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      background-color: #333;
      /* 입력란 배경 어두운 색 */
      color: white;
    }

    .deleteAll {
  	background-color: #e91e63; /* 진한 핑크 */
	  color: white;
     }
	  
	#logTable select {
	  font-size: 16px;  /* 버튼과 동일하게 설정 */
  	  padding: 6px 12px;  /* 버튼과 여백도 맞춰주면 보기 좋음 */
	  font-weight: bold;   /* 굵기까지 맞추기 */
	  line-height: 1.4;
	}

.footer-button-container {
  text-align: center;
  margin-top: 30px;
  padding: 20px 0;
  border-top: 2px solid #ccc;
}

.footer-button-container button {
  padding: 12px 24px;
  margin: 5px;
  font-size: 16px;
  font-weight: bold;
  background-color: #607d8b;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.footer-button-container button:hover {
  background-color: #455a64;
}

    .footer-comment {
      margin-top: 15px;
      text-align: center;
      color: red;
      font-weight: bold;
      font-size: 16px;
     }

/* 확인 상태 텍스트 네모박스 스타일 */
.ack-text {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 4px;
  font-weight: bold;
  border: 1px solid black;
  user-select: none;
  cursor: default;
  color: black !important;
}

/* 미확인 - 노란색 배경, 검정 글씨 */
.ack-pending {
  background-color: #ffb74d; /* 밝은 주황색 */
  color: black !important;
  border-color: #ff9800; /* 기존 주황 테두리 */
}

/* 확인완료 - 초록색 배경, 흰색 글씨 */
.ack-confirmed {
  background-color: #4caf50;
  color: white !important;
  border-color: #388e3c;
}

/* 포함/제외 텍스트 네모박스 스타일 */
.exclude-text {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-weight: bold;
  user-select: none;
  border: 1px solid black;
  color: black !important;
  cursor: default;
  margin-top: 4px;
}

/* 포함 */
.exclude-include {
  background-color: #bbdefb; /* 연한 파란색 */
  border-color: #64b5f6;
  color: black !important;
}

/* 제외 */
.exclude-exclude {
  background-color: #ffcdd2; /* 연한 빨강색 */
  border-color: #e57373;
  color: black !important;
}

/* 깜빡임 애니메이션 정의 */
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}

/* 깜빡임 효과 클래스 */
.blink {
  animation: blink 1.2s infinite;
}


    /* 로그인 버튼 디자인 */
    .login-container button {
      width: 100%;
      padding: 12px;
      background-color: #FF9800;
      /* 버튼 색상 주황색 */
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }

    /* 버튼 호버 효과 */
    .login-container button:hover {
      background-color: #FF5722;
      /* 버튼 호버 시 색상 변경 (어두운 주황색) */
    }

    /* 오류 메시지 디자인 */
    .error-message {
      color: red;
      margin-top: 10px;
    }
  </style>

  <div id="dateCounts" style="margin-top: 20px;"></div>
  
  <!-- 실시간 서비스 페이지 -->
     <div id="service-container" style="display: none;">

	<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
	  <button onclick="openContentPopup()" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; font-weight: bold;">
	    📥 내용 등록
	  </button>
	  <div style="display: flex; align-items: center; gap: 10px;">
	    <button id="refreshButton" style="padding: 6px 12px; background-color: #607d8b; color: white; border-radius: 6px; border: none; cursor: pointer;">🔃 새로고침</button>
	    <span id="currentUser" style="background: #f1f1f1; padding: 6px 12px; border-radius: 20px; font-weight: bold;"></span>
	    <button onclick="logout()" style="padding: 6px 12px; border: none; background-color: #607d8b; color: white; border-radius: 8px;">로그아웃</button>
	  </div>
	</div>

	  
<h1 class="header-fixed" style="font-size: 28px;">📡 6사보도 실시간 서비스</h1>
	  
<!-- ✅ 기존 내용 등록 박스 제거 또는 주석처리 -->
<!--	  
<div style="
  max-width: 500px;
  margin: 30px auto;
  padding: 30px 20px;
  background: linear-gradient(to bottom right, #fff5f7, #ffeef1);
  border: 2px solid #ffb6c1;
  border-radius: 16px;
  box-shadow: 0 8px 16px rgba(255, 182, 193, 0.3);
  text-align: center;
">

	  <h2 style="margin-bottom: 20px;">내용 등록</h2>
	  <input id="inputContent" type="text" placeholder="내용 입력" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #ccc;" />
	  <select id="inputSender" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px;">
	    <option value="SBS">SBS</option>
	    <option value="KBS">KBS</option>
	    <option value="MBC">MBC</option>
	    <option value="MBN">MBN</option>
	    <option value="YTN">YTN</option>
	    <option value="OBS">OBS</option>
	    <option value="LGU+">LGU+</option>
	  </select>
	
	  <div style="margin-bottom: 15px;">
	    <p style="margin-bottom: 6px;">이 내용에서 제외할 수신사 선택</p>
	    <label><input type="checkbox" value="KBS" /> KBS</label>
	    <label><input type="checkbox" value="MBC" /> MBC</label>
	    <label><input type="checkbox" value="SBS" /> SBS</label>
	    <label><input type="checkbox" value="MBN" /> MBN</label>
	    <label><input type="checkbox" value="YTN" /> YTN</label>
	    <label><input type="checkbox" value="OBS" /> OBS</label>
	  </div>
	
	  <button onclick="registerContent()" style="width: 100%; padding: 12px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; font-weight: bold;">등록</button>
	</div>
	     -->

  <!--  <p id="currentUser" style="font-size: 18px; color: #333;">로그인된 사용자: </p> 로그인한 사용자 표시 -->


  <div class="button-container header-fixed">
    <!--  <button class="add" onclick="addRow()">➕ 행 추가</button> -->
    <!--  <button class="delete" onclick="deleteRow()">🗑 행 삭제</button> -->
    <!--      <button class="save" onclick="saveData()">💾 저장</button> -->
    <!--   <button class="logout" onclick="logout()">로그아웃</button> -->
    </div>


<div class="table-wrapper">
    <table id="logTable">
      <thead>
        <tr>
	  <th rowspan="2">번호</th>
	<!--  <th rowspan="2">송출구분</th>   ✅ 여기 추가 -->
          <th rowspan="2">날짜</th>
          <th rowspan="2">올린시간</th>
	  <th rowspan="2">송출사</th>
          <th rowspan="2">내용</th>
          <th colspan="12">수신사</th>
	  <th rowspan="2">상태/관리</th>
        </tr>
<tr>
<th colspan="2"><img src="/static/KBS.png" class="logo-img" alt="KBS"></th>
<th colspan="2"><img src="/static/MBC.png" class="logo-img" alt="MBC"></th>
<th colspan="2"><img src="/static/SBS.png" class="logo-img" alt="SBS"></th>
<th colspan="2"><img src="/static/MBN.png" class="logo-img" alt="MBN"></th>
<th colspan="2"><img src="/static/YTN.png" class="logo-img" alt="YTN"></th>
<th colspan="2"><img src="/static/OBS.png" class="logo-img" alt="OBS"></th>
</tr>

      </thead>
      <tbody id="tableBody"></tbody>
    </table>
</div>
    <div class="footer-button-container">
    <button id="alarmToggleButton" class="send" onclick="toggleAlarm()">🔔자료송출 알림</button>
    <button onclick="stopAlarm()" class="stop">🛑 전체 알람 정지</button>
  <!--  <button id="refreshButton" class="refresh">🔃웹페이지 새로고침</button> -->
    <button onclick="openAllView()">🧾송출 이력 보기</button>
  <!--  <button id="toggleViewButton" onclick="toggleView()">📋 기본 보기</button> -->
    <button onclick="downloadAsExcel()">📊 엑셀로 저장</button>
    <button id="backupButton" class="deleteAll" onclick="deleteAllhides()">📋자료송출 내역 백업</button>
  <!-- <button class="danger-button" onclick="deleteAllRows()">❌ 전체 행 완전 삭제</button> -->
    </div>

  </div>
	
<div id="alarmPopup" style="
  display: none;
  position: fixed;
  top: 30%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 0 12px rgba(0,0,0,0.3);
  text-align: center;
  z-index: 9999;
">
  <p class="alarm-text" style="font-size: 18px; font-weight: bold;">🔔 자료 송출 알림이 발생했습니다!</p>
  <p>확인을 누르면 이 계정에서만 알림이 정지됩니다.</p>
  <button onclick="acknowledgeAlarm()" style="margin-top: 20px; padding: 10px 20px; font-size: 16px;">✅ 확인</button>
</div>

<!-- 알람 팝업 컨테이너 -->
<div id="alarmPopupContainer" style="
  position: fixed;
  top: 30%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
  max-width: 400px;
  width: 90%;
">
  <!-- 팝업이 여기에 여러 개 동적 생성됨 -->
</div>


<!-- 내용 등록 팝업 -->
<div id="contentPopup" style="display: none; position: fixed; top: 50px; left: 30px; width: 400px; background: #fff; border: 2px solid #4CAF50; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999;">
  <h3 style="margin-top: 0; color: #4CAF50;">📝 내용 등록</h3>
  <input id="inputContent" type="text" placeholder="내용 입력" style="width: 100%; margin-bottom: 10px;" />
  <select id="inputSender" style="width: 100%; margin-bottom: 10px;">
    <option value="SBS">SBS</option>
    <option value="KBS">KBS</option>
    <option value="MBC">MBC</option>
    <option value="MBN">MBN</option>
    <option value="YTN">YTN</option>
    <option value="OBS">OBS</option>
    <option value="LGU+">LGU+</option>
  </select>
  <div style="margin-bottom: 10px;">
    <p style="margin-bottom: 4px;">포함 수신사 선택</p>
  <label><input type="checkbox" value="KBS" checked /> KBS</label>
  <label><input type="checkbox" value="MBC" checked /> MBC</label>
  <label><input type="checkbox" value="SBS" checked /> SBS</label>
  <label><input type="checkbox" value="MBN" checked /> MBN</label>
  <label><input type="checkbox" value="YTN" checked /> YTN</label>
  <label><input type="checkbox" value="OBS" checked /> OBS</label>
  </div>
  <div style="text-align: right;">
    <button onclick="registerContent()" style="background-color: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 6px;">등록</button>
    <button onclick="closeContentPopup()" style="margin-left: 6px; background-color: #ccc; color: black; border: none; padding: 8px 16px; border-radius: 6px;">닫기</button>
  </div>
</div>

	
  <style>

    #logTable {
	  width: 100%;
	  border-collapse: collapse;
	  margin-top: 20px;
	  background-color: #ffffff; 
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
    }

    thead th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
	  
	tbody tr {
	  background-color: inherit;
	}

    td[contenteditable] {
      border: 1px solid #ccc;
    }
  </style>

<!-- ✅ 새롭게 닫힌 후 여기에 스타일 추가 -->
<style>
.logo-KBS {
  font-weight: bold;
  color: #00338D;
  font-size: 1.1rem;
  font-family: "Arial Black", sans-serif;
  letter-spacing: 1px;
}
.logo-MBC {
  font-weight: bold;
  color: #1c1c1c;
  font-size: 1.1rem;
  font-family: "Verdana", sans-serif;
}
.logo-SBS {
  font-weight: bold;
  color: #0a84ae;
  font-size: 1.1rem;
  font-family: "Tahoma", sans-serif;
}
.logo-MBN {
  font-weight: bold;
  color: #f37021;
}
.logo-YTN {
  font-weight: bold;
  color: #0066cc;
}
.logo-OBS {
  font-weight: bold;
  color: #4caf50;
}
</style>
	
<style>
.logo-img {
  width: 60px;
  height: 24px;
  object-fit: contain;     /* 비율 유지하며 이미지 전체 보이기 */
  display: block;
  margin: auto;
  background-color: #f0f0f0; /* 이미지 깨졌을 때 배경 처리 */
}
</style>
<script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>
